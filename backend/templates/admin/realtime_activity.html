{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Actividad en Tiempo Real - Administraci√≥n{% endblock %}

{% block extrastyle %}
<style>
    .realtime-container {
        padding: 20px;
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    .status-live {
        background: #28a745;
    }

    .status-error {
        background: #dc3545;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .metric-value {
        font-size: 3em;
        font-weight: bold;
        color: #417690;
        margin: 10px 0;
        font-family: 'Courier New', monospace;
    }

    .metric-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-sublabel {
        color: #999;
        font-size: 0.75em;
        margin-top: 5px;
    }

    .activity-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-header {
        font-size: 1.3em;
        font-weight: 600;
        color: #417690;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .org-activity-item {
        padding: 12px;
        border-left: 4px solid #417690;
        background: #f8f9fa;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .org-name {
        font-weight: 600;
        color: #333;
    }

    .activity-stats {
        display: flex;
        gap: 15px;
        font-size: 0.9em;
    }

    .activity-stat {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .recent-activity-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }

    .recent-activity-item:hover {
        background: #f9f9f9;
    }

    .recent-activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        margin-right: 12px;
    }

    .icon-cita {
        background: #d1ecf1;
    }

    .icon-message {
        background: #d4edda;
    }

    .icon-user {
        background: #fff3cd;
    }

    .activity-time {
        color: #999;
        font-size: 0.85em;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    .update-time {
        color: #999;
        font-size: 0.85em;
        text-align: right;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="realtime-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h1>‚ö° Actividad en Tiempo Real</h1>
            <p style="color: #666; margin: 5px 0;">
                Monitoreo en vivo de la actividad del sistema
            </p>
        </div>
        <div>
            <span class="status-indicator status-live" id="statusIndicator"></span>
            <span id="statusText" style="color: #28a745; font-weight: 600;">En vivo</span>
        </div>
    </div>

    <!-- M√©tricas Globales -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Usuarios Conectados</div>
            <div class="metric-value" id="usersOnline">0</div>
            <div class="metric-sublabel">√öltimos 5 minutos</div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Citas (1 min)</div>
            <div class="metric-value" id="citasMinute">0</div>
            <div class="metric-sublabel" id="citasHourLabel">0 en la √∫ltima hora</div>
        </div>

        <div class="metric-card">
            <div class="metric-label">Mensajes WhatsApp (1 min)</div>
            <div class="metric-value" id="messagesMinute">0</div>
            <div class="metric-sublabel" id="messagesHourLabel">0 en la √∫ltima hora</div>
        </div>
    </div>

    <!-- Actividad por Organizaci√≥n -->
    <div class="activity-section">
        <div class="section-header">üìä Actividad por Organizaci√≥n</div>
        <div id="orgActivityList">
            <div class="empty-state">
                <p>Esperando datos...</p>
            </div>
        </div>
    </div>

    <!-- Actividades Recientes -->
    <div class="activity-section">
        <div class="section-header">üïê Actividades Recientes</div>
        <div id="recentActivitiesList">
            <div class="empty-state">
                <p>No hay actividades recientes</p>
            </div>
        </div>
        <div class="update-time">
            √öltima actualizaci√≥n: <span id="lastUpdate">-</span>
        </div>
    </div>

    <!-- Volver -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <a href="{% url 'admin_dashboard' %}" style="color: #417690; text-decoration: none;">
            ‚Üê Volver al Dashboard
        </a>
    </div>
</div>

<script>
let eventSource = null;

function connectToActivityStream() {
    // Cerrar conexi√≥n previa si existe
    if (eventSource) {
        eventSource.close();
    }

    // Crear nueva conexi√≥n SSE
    eventSource = new EventSource('{% url "activity_stream" %}');

    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);

            if (data.error) {
                showError(data.error);
                return;
            }

            updateMetrics(data);
            updateStatus('live');
        } catch (error) {
            console.error('Error parsing SSE data:', error);
            showError('Error al procesar datos');
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE Error:', error);
        updateStatus('error');

        // Intentar reconectar despu√©s de 5 segundos
        setTimeout(() => {
            console.log('Attempting to reconnect...');
            connectToActivityStream();
        }, 5000);
    };

    eventSource.onopen = function() {
        console.log('SSE connection opened');
        updateStatus('live');
    };
}

function updateMetrics(data) {
    // Actualizar m√©tricas globales
    document.getElementById('usersOnline').textContent = data.global.users_online;
    document.getElementById('citasMinute').textContent = data.global.citas_last_minute;
    document.getElementById('citasHourLabel').textContent = `${data.global.citas_last_hour} en la √∫ltima hora`;
    document.getElementById('messagesMinute').textContent = data.global.messages_last_minute;
    document.getElementById('messagesHourLabel').textContent = `${data.global.messages_last_hour} en la √∫ltima hora`;

    // Actualizar lista de organizaciones con actividad
    const orgList = document.getElementById('orgActivityList');
    if (data.organizations.length === 0) {
        orgList.innerHTML = '<div class="empty-state"><p>No hay actividad reciente</p></div>';
    } else {
        orgList.innerHTML = data.organizations.map(org => `
            <div class="org-activity-item">
                <div class="org-name">${escapeHtml(org.nombre)}</div>
                <div class="activity-stats">
                    <div class="activity-stat">
                        üë• <strong>${org.users_online}</strong> online
                    </div>
                    <div class="activity-stat">
                        üìÖ <strong>${org.citas_last_hour}</strong> citas (1h)
                    </div>
                    <div class="activity-stat">
                        üí¨ <strong>${org.messages_last_hour}</strong> mensajes (1h)
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Actualizar actividades recientes
    const activityList = document.getElementById('recentActivitiesList');
    if (data.recent_activities.length === 0) {
        activityList.innerHTML = '<div class="empty-state"><p>No hay actividades recientes</p></div>';
    } else {
        activityList.innerHTML = data.recent_activities.map(activity => {
            const timestamp = new Date(activity.timestamp);
            const timeAgo = getTimeAgo(timestamp);
            const estadoBadge = getEstadoBadge(activity.estado);

            return `
                <div class="recent-activity-item">
                    <div style="display: flex; align-items: center;">
                        <div class="activity-icon icon-cita">üìÖ</div>
                        <div>
                            <div><strong>${escapeHtml(activity.org_nombre)}</strong> - Cita #${activity.cita_id}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                    <div>
                        ${estadoBadge}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Actualizar timestamp
    document.getElementById('lastUpdate').textContent = new Date(data.timestamp).toLocaleTimeString('es-CO');
}

function updateStatus(status) {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');

    if (status === 'live') {
        indicator.className = 'status-indicator status-live';
        text.textContent = 'En vivo';
        text.style.color = '#28a745';
    } else {
        indicator.className = 'status-indicator status-error';
        text.textContent = 'Desconectado';
        text.style.color = '#dc3545';
    }
}

function showError(message) {
    updateStatus('error');
    console.error('Activity stream error:', message);
}

function getEstadoBadge(estado) {
    const badges = {
        'pendiente': '<span class="badge badge-warning">Pendiente</span>',
        'confirmada': '<span class="badge badge-info">Confirmada</span>',
        'completada': '<span class="badge badge-success">Completada</span>',
        'cancelada': '<span class="badge badge-danger">Cancelada</span>'
    };
    return badges[estado] || `<span class="badge badge-info">${escapeHtml(estado)}</span>`;
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    if (seconds < 60) return 'Hace unos segundos';
    if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} minutos`;
    if (seconds < 86400) return `Hace ${Math.floor(seconds / 3600)} horas`;
    return `Hace ${Math.floor(seconds / 86400)} d√≠as`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Conectar al iniciar la p√°gina
connectToActivityStream();

// Limpiar al cerrar la p√°gina
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>
{% endblock %}
